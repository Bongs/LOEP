<% readonly ||= false %>

<div class="loep_form_wrapper">
  <p class="form_before_button">&nbsp;</p>

  <%= form_for(@evaluation) do |f| %>

    <%= f.hidden_field :user_id, :value => current_user.id, :class => "skipValidation" %>

    <% if !@assignment.nil? %>
      <%= f.hidden_field :assignment_id, :value => @assignment.id, :class => "skipValidation" %>
    <% end %>
    <%= f.hidden_field :lo_id, :value => @lo.id, :class => "skipValidation"%>
    <%= f.hidden_field :evmethod_id, :value => @evmethod.id, :class => "skipValidation"%>

    <%= render 'survey', :f => f , :readonly => readonly %>

    <% if iamAdmin? and !@evaluation.completed_at.nil? %>
      <p class="form_legend">Completion Date</p>
      <%= f.text_field :completed_at, :value => @evaluation.readable_completed_at, :class=>'loep_input', :id=>"completed_at_datepicker", :readonly => readonly ? "true" : nil%>
    <% end %>

    <p class="form_before_button">&nbsp;</p>
    <p class="form_before_button">&nbsp;</p>
    <%= f.submit "Submit  #{@evmethod.name}  Evaluation", :class => 'loep_button' if !readonly %>

  <% end %>
</div>

<script type="text/javascript">
  jQuery(document).ready(function($){

    if (($("#completed_at_datepicker").length > 0)&&(typeof $("#completed_at_datepicker").attr("readonly") == "undefined")){
      $('#completed_at_datepicker').datetimepicker({
        yearRange: "-1:+10",
        showOn: "both",
        dateFormat : 'dd/mm/yy',
        changeMonth : true,
        changeYear : true,
        minDate: '0d',
        buttonImage: "/assets/calendar_icon.png", 
        buttonImageOnly: true,
        timeFormat: "HH:mm tt",
        stepHour: 1,
        stepMinute: 15
      });
    }


    var validateForm = true;

    $('form').submit(function(event){
      if(validateForm==true){
        event.preventDefault();
        _beforeSubmit($(this), function(error){
          if(typeof error != "undefined"){
            //onError or Cancel
            return false;
          } else {
            //onSuccess or Ok
            validateForm = false;
            $('form').trigger("submit");
            return true;
          }
        });
      }
    });

    var _beforeSubmit = function(form, callback) {
      if(typeof callback != "function"){
          return;
      }

      var fields = _getFieldsOfForm(form);
      var unfilledFields = _getUnfilledFields(form,fields);
      var numberOfFilledFields = fields.length - unfilledFields.length;

      if(numberOfFilledFields == 0){
        var error = {};
        error.msg = "The evaluation survey is blank. It cannot be sent.";
        _showLOEPDialog(error.msg,false);
        callback(error);
      } else if (unfilledFields.length > 0){
        //Warning

        var warningDialogMsg;
        if(unfilledFields.length == 1){
          warningDialogMsg = "There is one question that has not been answered.";
        } else {
          warningDialogMsg = "There are " + unfilledFields.length + " questions that have not been answered.";
        }
        warningDialogMsg += " Are you sure you want to submit the evaluation survey?"

        _showLOEPDialog(warningDialogMsg, true, function(result){
          if(result==true){
            //Ok
            callback();
          } else {
            //Cancel
            callback({"msg":"Incompleted survey"});
          }
        })
      } else {
          callback();
      }
    }

    var _getFieldsOfForm = function(form){
      //Ignore submit fields, and also inputs with 'optionalInput' or 'skipValidation' class
      var inputs = $(form).find(':input:not(.optionalInput):not(.skipValidation)[type!="submit"]');
      var fields = [];

      $(inputs).each(function(index,input){
        var fieldName = $(input).attr("name");
        if(fields.indexOf(fieldName) == -1){
          fields.push(fieldName);
        }
      });

      return fields;
    };

    var _getUnfilledFields = function(form,fields){
      var unfilledFields = [];
      $(fields).each(function(index,field){
        var fieldValue;
        var input = $(form).find('input[name="'+field+'"]');
        if($(input).is(":radio")){
          fieldValue = $(form).find('input[name="'+field+'"]:checked', form).val();
        } else {
          //hidden, text
          fieldValue = $(input).val();
        }
        if((typeof fieldValue != "string")||(fieldValue.trim()=="")){
          unfilledFields.push(field);
        }
      });
      return unfilledFields;
    }

  });
</script>
