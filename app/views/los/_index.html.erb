<% rL = @los.length %>
<% if rL === 0 %>
  <%= render '/layouts/emptytable', :resources => "learning objects" %>
<% else %>
  <div class="loep_table_tools">
    <a id="automatic_assign_los">
      <div class="loep_tool_button">
        <span class="glyphicon glyphicon-time"></span><span class="glyphicon glyphicon-user"></span>
        <span class="loep_tool_text">Automatic Assignments</span>
      </div>
    </a>
    <a id="assign_los">
      <div class="loep_tool_button">
        <span class="glyphicon glyphicon-time"></span>
      </div>
    </a>
    <a id="remove_los">
      <div class="loep_tool_button">
        <span class="glyphicon glyphicon-trash"></span>
      </div>
    </a>
  </div>
  <table id="los_table" cellspacing='0' class="loep_table">
    <thead>
      <tr>
        <th><input type="checkbox" class="checkalllos" autocomplete="off" value="all"/></th>
        <th>Name</th>
        <th>Url</th>
        <th>Assign</th>
        <th class="longhead">View as reviewer</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
    <% @los.each do |lo| %>
      <tr>
        <td class="tdcenter">
          <input type="checkbox" class="checklo" autocomplete="off" value="<%=lo.id%>"/>
        </td>
        <td>
          <a href="<%=lo_path(lo)%>"><%= lo.name %></a>
        </td>
        <td class="tdcenter">
          <a target="_blank" href="<%=lo.url%>"><span class="glyphicon glyphicon-share"></span></a>
        </td>
        <td class="tdcenter tdrshow">
          <a href="<%=new_assignment_path_for(lo.id,nil)%>"><span class="glyphicon glyphicon-time"></span></a>
        </td>
        <td class="tdcenter tdrshow">
          <a href="<%=rlo_path(lo)%>"><span class="glyphicon glyphicon-eye-open"></span></a>
        </td>
        <td class="tdcenter tdedit">
            <a href="<%=edit_lo_path(lo)%>"><span class="glyphicon glyphicon-edit"></span> Edit</a>
        </td>
        <td class="tdcenter tddestroy">
          <a href="<%=lo_path(lo)%>" data-confirm="Are you sure?" data-method="delete" rel="nofollow"><span class="glyphicon glyphicon-trash"></span> Remove</a>
        </td>
      </tr>
    <% end %>
    <tbody>
  </table>
<% end %>

<script type="text/javascript">

  //Store the ids
  //selectedLOs[lo_id] = lo_id
  var selectedLOs = {};

  $(document).ready(function(){

    //////////////////
    // Table Basics
    //////////////////

    $("input:checkbox.checklo").change(function(){
        var lotr = $(this).parent().parent();
        var loId = $(this).attr("value");

        if(this.checked) {
          selectedLOs[loId] = loId;
          $(lotr).addClass("loeprowselected");
        } else {
          delete selectedLOs[loId];
          $(lotr).removeClass("loeprowselected");
          $("input:checkbox.checkalllos").prop("checked",false);
        }
    });

    $("input:checkbox.checkalllos").change(function(){
      if(this.checked){
        $("input:checkbox.checklo").prop("checked",true);
        $("input:checkbox.checklo").parent().parent().addClass("loeprowselected");
        $("input:checkbox.checklo").each(function(index,input){
          var loId = $(input).attr("value");
          selectedLOs[loId] = loId;
        });
      } else {
        $("input:checkbox.checklo").prop("checked",false);
        $("input:checkbox.checklo").parent().parent().removeClass("loeprowselected");
        selectedLOs = {};
      }
    });

    //////////////////
    //Toolbar Actions
    //////////////////

    $("#assign_los").click(function(){
      var lo_ids = getSelectedLos();
      if(lo_ids.length===0){
        _showLOEPDialog("You have not selected any item.", false);
        return;
      }
      var url = _createURL("/assignments/new",[["lo_ids", lo_ids]]);
      window.top.location= url;
    });

     $("#automatic_assign_los").click(function(){
      var lo_ids = getSelectedLos();
      if(lo_ids.length===0){
        var url = "/automatic_assignments/new";
      } else {
        var url = _createURL("/automatic_assignments/new",[["lo_ids", lo_ids]]);
      }
      window.top.location= url;
    });

    $("#remove_los").click(function(){
      var lo_ids = getSelectedLos();
      if(lo_ids.length===0){
        _showLOEPDialog("You have not selected any item.", false);
        return;
      }

     _showLOEPDialog("Are you sure?", true, function(result){
        if(result==true){
          var lo_ids = getSelectedLos();
          if(lo_ids.length===0){
            return;
          }
          var url = _createURL("/los/remove",[["lo_ids", lo_ids]]);
          window.top.location= url;
        }
      });
    });

    //////////////////
    // Table Sorter
    //////////////////

    //DOC: http://datatables.net
    $("#los_table").dataTable({
      "bJQueryUI": true,
      "sPaginationType": "full_numbers",
      "aaSorting": [[ 1, "asc" ]],
      "aoColumnDefs": [
          { 'bSortable': false, 'aTargets': [ 0,2,3,4,5,6 ] }
      ],
      "sDom": '<"H"lfr><"F"ip>t',
      "iDisplayLength": 50,
      "oLanguage": {
        "sLengthMenu": 'Display <select>'+
          '<option value="5">5</option>'+
          '<option value="10">10</option>'+
          '<option value="25">25</option>'+
          '<option value="50">50</option>'+
          '<option value="100">100</option>'+
          '<option value="-1">All</option>'+
          '</select> records'
      }
    });

  });

  /* Select only visible elements */
  var getSelectedLos = function(){
    var lo_ids = [];
    $("input:checkbox.checklo:checked").each(function(index,input){
      lo_ids.push($(input).attr("value"));
    });
    return lo_ids;
  };

  // var getSelectedLos = function(){
  //   return Object.keys(selectedLOs);
  // };

  var _createURL = function(base,objects){
    var url = base;
    $(objects).each(function(index,obj){

      if((typeof obj != "object")||(typeof obj.length != "number")){
        return;
      }

      if (index==0) {
        url = url + "?"
      } else {
        url = url + "&"
      }

      url = url + obj[0] + "="

      $(obj[1]).each(function(index,value){
        if (index!=0) {
          url = url + ","
        }
        url = url + value
      });
    });

    return url;
  }



</script>