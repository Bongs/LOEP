<% showTools ||= false %>

<% rL = @los.length %>
<% if rL === 0 %>
  <%= render '/layouts/emptytable', :resources => "learning objects" %>
<% else %>
  <table id="rankedLosTable" cellspacing='0' class="loep_table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Url</th>
        <th>Tags</th>
        <% @metrics.each do |metric| %>
        <th><%=metric.name=%></th>
        <% end %>
      </tr>
    </thead>
    <tbody>
    <% @los.each do |lo| %>
      <tr>
        <td>
          <a href="<%=lo_path(lo)%>"><%= lo.name %></a>
        </td>
        <td class="tdcenter">
          <a target="_blank" href="<%=lo.url%>"><span class="glyphicon glyphicon-share"></span></a>
        </td>
         <td class="tdcenter">
          <p> <%=lo.tag_list.join(", ")%> </p>
        </td>
        <% @metrics.each do |metric| %>
        <% loScore = lo.scores.where(:metric_id => metric.id).first %>
        <td class="tdcenter">
          <p> <%= loScore.nil? ? "No evaluated" : loScore.value %></p>
        </td>
        <%end%>
      </tr>
    <% end %>
    </tbody>
  </table>
<% end %>


<% if showTools %>


<script type="text/javascript">

  $(document).ready(function(){

    //////////////////
    // Table Sorter
    //////////////////

    var iDisplayLength = LOEP.Storage.get("RankedLosTable_iDisplayLength") || -1;
    
    var metricsLength = parseInt('<%=@metrics.length%>');
    var bSearchableArray = [1];
    var scoresArray = [];
    for(var i=3; i<(metricsLength+3); i++){
        // bSearchableArray.push(i); (Allow to search metric values)
        scoresArray.push(i);
    }

    //Custom Sorting
    jQuery.fn.dataTableExt.oSort['scores-asc'] = function(a,b){
      if(a.indexOf("No")!=-1){
        return -1;
      } else if(b.indexOf("No")!=-1){
        return 1;
      }
      return jQuery.fn.dataTableExt.oSort['html-asc'](a,b);
    };

    jQuery.fn.dataTableExt.oSort['scores-desc'] = function(a,b){
      return jQuery.fn.dataTableExt.oSort['scores-asc'](a,b)*(-1);
    };

    //DOC: http://datatables.net
    var losTable = $("#rankedLosTable").dataTable({
      "bJQueryUI": true,
      "sPaginationType": "full_numbers",
      "aaSorting": [[ 3, "desc" ]],
      "aoColumnDefs": [
          { 'bSortable': false, 'aTargets': [ 1,2 ] },
          { "bSearchable": false, "aTargets": bSearchableArray },
          { "sType":"scores", "aTargets": scoresArray }
      ],
      "sDom": '<"H"lfr><"F"ip>t',
      "iDisplayLength": iDisplayLength,
      "oLanguage": {
        "sLengthMenu": 'Display <select>'+
          '<option value="5">5</option>'+
          '<option value="10">10</option>'+
          '<option value="25">25</option>'+
          '<option value="50">50</option>'+
          '<option value="100">100</option>'+
          '<option value="-1">All</option>'+
          '</select> records'
      }
    });

    //DataTable events: http://datatables.net/docs/DataTables/1.9.4/#page

    //Draw event, fired whenever the table is redrawn on the page, at the same point as fnDrawCallback. This may be useful for binding events or performing calculations when the table is altered at all.
    $(losTable).on('draw', function(e){
      $("input:checkbox.checkalllos").prop("checked",false);
      $("input:checkbox.checkalllos").trigger("change");
    });

    $('#los_table_length').on('change', function(e){
      var iDisplayLength = parseInt($(this).find("select").val());
      LOEP.Storage.add("RankedLosTable_iDisplayLength",iDisplayLength);
    });

  });

</script>

<% end %>
